{{> header}}

<div class="container" id="wrapper-header">
    <div class="row">
        <div class="col-md-6 col-md-push-3">
            <div id="auth-well" class="well well-custom-red">
                <noscript>
                    <div class="alert alert-danger alert-sm" role="alert" style="margin-bottom: 12px;">You must have JavaScript enabled to authenticate with the GitHub API</div>
                </noscript>
                <div id="save-success" class="alert alert-success alert-sm" role="alert" style="display: none;margin-bottom: 12px;">Access token successfully saved</div>
                <div id="token-revoked" class="alert alert-info alert-sm" role="alert" style="display: none;margin-bottom: 12px;">Access token has been revoked</div>
                <div id="bad-credentials" class="alert alert-warning alert-sm" role="alert" style="display: none;margin-bottom: 12px;">Access token unable to be saved - bad credentials</div>
                <div id="no-input" class="alert alert-warning alert-sm" role="alert" style="display: none;margin-bottom: 12px;">Please enter a valid access token</div>
                <input type="text" name="access_token" id="access_token" tabindex="1" class="form-control form-text-box" style="width:100%" placeholder="Access Token" value="">
                <div class="row" style="margin-top:12px;">
                    <div class="col-md-6">
                        <div class="auth-group-1" style="display:none">
                            <a class="btn btn-danger btn-auth" onclick="revokeToken()">Revoke</a>
                        </div>
                        <div class="auth-group-2" style="display:none">
                            <a class="btn btn-success btn-auth" onclick="saveToken()">Save</a>
                            <a class="btn btn-info btn-auth" href="https://github.com/login/oauth/authorize?client_id=da313f2b7ca18563b216">Generate Access Token</a>
                        </div>
                        <br>
                        Using a GitHub API access token to authorize your map downloads will allow you to increase the amount of maps you can download per hour significantly.
                        <i>This token only allows us to access your public information.</i>
                    </div>
                    <div class="col-md-6">
                        <div class="auth-group-1" style="display:none">
                            Welcome to ResourcePile, <strong id="user_user_name"></strong>.<br><br>
                            You currently have <code id="user_rate_remaining"></code> requests of <code id="user_rate_limit"></code> remaining to the GitHub API, which means you can download approximately <code id="user_rate_approximate"></code> more maps from our <a href="/maps">collections</a>.
                        </div>
                        <div class="auth-group-2" style="display:none">
                            <h6><strong>How to generate an access token</strong></h6>
                            <ol>
                                <li>Click <code>Generate Access Token</code></li>
                                <li>Click <code>Authorize MCResourcePile</code></li>
                                <li>Open the <code>access_token</code> file downloaded</li>
                                <li>Copy the string of numbers and letters following <code>access_token=</code> (this will be 40 characters long)</li>
                                <li>Paste the token into field above and click <code>Save</code></li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>.content-background {background-color: #ededed;}</style>
<script>
    var token_current = Cookies.get('rp_user_token');
    if (token_current) {
        $('#access_token').val(token_current);
        $('#auth-well').addClass('well-custom-green');
        $('.auth-group-1').show();
        user = (function () {
                user = null;
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': 'https://api.github.com/user?access_token=' + token_current,
                    'dataType': "json",
                    'success': function (data) {
                        user = data;
                    }
                });
            return user;
        })();
        $('#user_user_name').text(user.login);
        ratelimit = (function () {
                ratelimit = null;
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': 'https://api.github.com/rate_limit?access_token=' + token_current,
                    'dataType': "json",
                    'success': function (data) {
                        ratelimit = data;
                    }
                });
            return ratelimit;
        })();
        $('#user_rate_remaining').text(ratelimit.rate.remaining);
        $('#user_rate_limit').text(ratelimit.rate.limit);
        $('#user_rate_approximate').text(Math.round(ratelimit.rate.remaining / 7));
    } else {
        $('.auth-group-2').show();
    }

    function revokeToken() {
        if (token_current) {
            if (confirm("Are you sure you want to revoke your access token?") == true) {
                Cookies.remove('rp_user_token');
                $("#token-revoked").show().delay(5000).fadeOut();
                $('#access_token').val('');
                $('#auth-well').removeClass('well-custom-green');
                $('.auth-group-1').hide();
                $('.auth-group-2').show();
                $('.auth-enabled').hide();
                $('.auth-disabled').show();
            } else {
                return false;
            }
        }
    }

    function saveToken() {
        var token_input = $('#access_token').val();
        response = (function () {
                response = null;
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': 'https://api.github.com/rate_limit?access_token=' + token_input,
                    'dataType': "json",
                    'success': function (data) {
                        response = data;
                    }
                });
            return response;
        })();
        if (token_input == '') {
            $("#no-input").show().delay(5000).fadeOut();
        } else if (token_input && response !== null) {
            Cookies.set('rp_user_token', token_input, { expires: 365 });
            $("#save-success").show().delay(5000).fadeOut();
            $('#auth-well').addClass('well-custom-green');
            $('.auth-group-1').show();
            $('.auth-group-2').hide();
            $('.auth-enabled').show();
            $('.auth-disabled').hide();
        } else {
            $("#bad-credentials").show().delay(5000).fadeOut();
        }
    }
</script>
{{> footer}}
</body>
</html>
